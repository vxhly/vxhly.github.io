---
author: 星火燎原@vxhly
title: 系统架构下午-案例分析-数据库
category: [软考]
tag:
  - 软考
  - 系统架构设计师

date: 2024-03-08 19:25:19
---

::: tip 前言

`系统架构设计师` 考试中下午案例分析题知识点汇总。本篇是数据库专题部分。

:::

## 概念

### 超类实体

某个实体类型中所有实体同时也是另一个实体类型中的实体，此时称前一实体为子类实体，后一实体为超类实体。或根据官方教程由一种已知类型定义新的类型。通常把已知类型称为超类, 新定义的类型称为子类。

### 派生属性

实体的某个属性可以从其他属性或其他数据推导出来，那么这个属性就是派生属性。

## 数据库设计过程

### 设计阶段

| 阶段                 | 主要任务                                                                                    |
| -------------------- | ------------------------------------------------------------------------------------------- |
| 用户需求分析         | 分析用户活动、收集数据确定系统边界。                                                        |
| 概念结构设计         | 将应用对象抽象成不依赖于 DBMS 的数据模型，即概念模型。描述概念模型的较理想的工具是 E-R 图。 |
| 逻辑结构设计         | 将抽象的概念模型转化为与选用的 DBMS 产品所支持的数据模型相符合的逻辑模型，即关系模式。      |
| 物理结构设计         | 是逻辑模型在计算机中的具体实现方案。                                                        |
| 数据库实施阶段       | 根据前两个阶段的结果建立数据库，编制与调试应用程序，组织数据入库，并进行试运行。            |
| 数据库运行和维护阶段 | 数据库应用系统经过试运行即可投入运行，但该阶段需要不断地对系统进行评价、调整与修改。        |

### 需求分析

调查组织机构情况、调查各部门的业务活动情况、协助用户明确对新系统的各种要求、确定新系统的边界，以此获得用户对系统的如下要求。
① `信息要求`: 保存的信息、完整性要求等。
② `处理要求`: 操作功能、处理的频度、相应时间等。
③ `系统要求`: 安全性要求、使用方式要求、可扩充性要求。

### 概念结构设计

对现实事物抽象认识的 3 种方法:

1. `分类(Classification)`: 对现实世界的事物，按照其具有的共同特征和行为，定义一种类型。在某一类型中，个体是类型的一个成员或实例，即 “is member of”。
2. `聚集(Aggregation)`: 定义某一类型所具有的属性。如学生类型具有学号、姓名、性别、班级等共同属性，每一个学生都是这一类型中的个体, 通过在这些属性上的不同取值来区分。各个属性是所属类型的一个成份，即 “is part of”。
3. `概括(Generalization)`: 由一种已知类型定义新的类型。通常把已知类型称为超类(Superclass), 新定义的类型称为子类(Subclass), 即 “is subset"

概念设计步骤

1. 需求分析
2. 确定局部视图范围
3. 识别实体及其标识
4. 确定实体之间的联系
5. 分配实体及联系的属性
6. 全局 E-R 模式设计

冲突的类型

1. 属性冲突
2. 结构冲突
3. 命名冲突

### 逻辑结构设计

- 将抽象的概念模型转化为与选用的 DBMS 产品所支持的数据模型相符合的逻辑模型，即关系模式。
- 主要工作步骤包括确定数据模型、将 E-R 图转换成为指定的数据模型、确定完整性约束和确定用户视图。

### 物理设计

物理设计的主要工作步骤包括确定数据分布、存储结构和访问方式。

### 数据库实施

数据库实施。在计算机上建立起实际的数据库结构，数据加载(或称装入)，进行试运行和评价的过程，叫作数据库的实施(或称实现)

### 数据库运行维护

数据库运行维护。数据库一旦投入运行，就标志着数据库维护工作的开始。数据库维护工作的主要内容包括对数据库性能的监测和改善、故障恢复、数据库的重组和重构。

## 反规范化设计

### 优点

- 避免进行表之间的连接操作，可以提高数据操作的性能。

### 缺点

- 数据的重复存储，浪费了磁盘空间
- 会产生数据的不一致性问题

### 反规范化设计类型

| 类型       | 作用 / 描述                                                                                                          |
| ---------- | -------------------------------------------------------------------------------------------------------------------- |
| 增加冗余列 | 增加冗余列是指在多个表中具有相同的列，它常用来在查询时避免连接操作。                                                 |
| 增加派生列 | 曾加派生列指增加的列可以通过表中其他数据计算生成它的作用是在查询时减少计算量，从而加快查询速度                       |
| 重新组表   | 重新组表指如果许多用户需要查看两个表连接出来的结果数据，则把这两个表重新组成一个表来减少连接而提高性能               |
| 水平分割表 | 按记录进行分割，把数据放到多个独立的表中，主要用于表数据规模很大、表中数据相对独立或数据需要存放到多个介质上时使用。 |
| 垂直分割表 | 对表进行分割，将主键与部分列放到一个表中，主键与其它列放到另一个表中，在查询时减少 1/0 次数。                        |

### 数据一致性

反规范化设计保证数据的一致性方法:

- 触发器
- 事务机制保证
- 应用保证
- 批处理脚本

## 数据库性能优化

### 主从复制

主从复制，是用来建立一个和主数据库完全一样的数据库环境，称为从数据库。这样做的好处是:

1. 做数据的热备。作为后备数据库，主数据库服务器故障后，可切换到从数据库继续工作，避免数据丢失。
2. 架构的扩展。、业务量越来越大，1/0 访问频率过高，单机无法满足此时做多库的存储，降低磁盘!/0 访问的频率，提高单个机器的 1/0 性能。
3. 读写分离。使数据库能支持更大的并发。

### 读写分离

读写分离: 设置不同的主/从数据库分别负责不同的操作。让主数据库负责数据的写操件，从数据库负责数据的读操作。通过角色分担的策略，分别提升读写性能，有效减少数据并发操作的延迟。

### 分库

分库，将原本存放在一个实例上众多分类的数据(表)，分开存放到不同的实例上。有利于差异化管理。

### 分表

分表也叫分片，解决并发能力、1/0 性能提升、将一张大表分成若干小表，业务同时访问多个表。分表是重在单个实例内部，一张表拆分成多个表。

## 分布式缓存技术

### Redis 作用

redis 用作缓存组件时，其基于肉存的读写特性，比基于磁盘读写的数据库性能要高很多，适合缓存高频热点的数据，来提高读性能这样可以降低对数据库服务器的查询请求，提高系统性能。

### Redis 读写数据基本步骤

读数据:

1. 根据 key 值查询缓存
2. 读取成功则直接返回
3. 如果 key 值不在缓存中, 则会根据 key 进行查询数据库
4. 读取成功后, 将数据写入缓存
5. 返回数据

写数据:

1. 根据 key 值写路数据库中
2. 写入成功后, 将数据更新至缓存
3. 成功返回

### Redis 数据类型

| 类型    | 举例                                                                                  |
| ------- | ------------------------------------------------------------------------------------- |
| string  | 实体的某个属性可以从其他属性或其他数据推导出来，那么这个属性就是派生属性。            |
| hash    | 代替 string 类型，节省空间。描述用户信息较为方便                                      |
| set     | 无序集合，每个值不能重复。可用于去重、抽奖、初始化用户池等                            |
| list    | 双向链表结构，可以模拟栈、队列等形式。可用于回复评论、点赞                            |
| zset    | 有序集合、每个元素有一个分数。如首页推荐 10 个最热门的帖子                            |
| pub/sub | 可以用做消息队列，生产者将消息投送给某个 key 为主题的队列，消费者监听并得到消息的推送 |

### Redis 持久化机制

|      | RDB 内存快照(RedisDataBase)      | AOF 日志(Append Only Flie) |
| ---- | -------------------------------- | -------------------------- |
| 说明 | 把当前内存中的数据集快照写入磁盘 |

(数据库中所有键
值对数据)恢复时是将快照文件直接读到内存里。 | 通过持续不断地保存 Redis 服务器所执行的更新命令来记录数据库状态，类似 mysql 的 binlog。恢复数据时需要从头开始回放更新命令。 |
| 磁盘刷新频率 | 低 | 高 |
| 文件大小 | 小 | 大 |
| 数据恢复效率 | 高 | 低 |
| 数据安全 | 低 | 高 |

### Redis 过期策略

- 惰性删除
  - 查询 key 的时候才对 key 进行检测，如果已经达到过期时间，则删除。缺点是如果这些过期的 key 没有被访问，那么他就一直无法被删除，而且一直占用内存。
- 定期删除
  - redis 每隔一段时间对数据库做一次检查，删除里面的过期 key。由于不可能对所有 key 去做轮询来删除，所以 redis 会每次随机取一些 key 去做检查和删除。
- 内存淘汰机制
  - 当内存不足时，redis 会根据一定的策略去删除一些 key。策略有 noeviction、allkeys-lru、volatile-lru、allkeys-random、volatile-random、volatile-ttl。

### Redis 缓存异常

1. 缓存穿透: 访问的 key 在 redis 中不存在，导致请求直接访问数据库。

| 原因                                        | 解决方案                                                                                                                                                                                                                                            |
| ------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 恶意攻击，造成大量访问 Redis 中不存在的 key | 1、针对来源是比较少的请求来源 ip 主动限制访问次数，或者拉入黑名单。2、应用程序检查 key 的合法性，提前拒绝不合法的请求。3、使用布隆过滤器。                                                                                                          |
| 大量请求访问数据库里有但 redis 没有的 key。 | 1、预热 redis，运行一个批处理脚本，将可能会大量访问的数据预先加载到 redis，业务再开张。2、在最前端进行流量控制，逐步释放进来请求。给出一段时间，让 redis 逐步加载热数据。3、如果数据库里也没有的 key，也要在 redis 中设置 key，使其值为 null 或空。 |

2. 缓存雪崩: Redis 的 key 是已存在的，但同时失效了。

| 原因                                                                         | 解决方案                                                                                                                       |
| ---------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| redis 故障。比如 redis 宕机，网路出现抖动等。                                | 1、使用主从复制提高可用性， 使用 cluster 集群方案降低故障时影响的范围。2、如果出现故障，则可以采取服务降级、熔断、限流等措施。 |
| 采用了相同的过期时间,例如在同一时刻设置了大量的 key，但过期时间都是 5 分钟。 | 过期时间加上一个随机值，使得众多 key 均匀过期。                                                                                |

3. 缓存击穿: 少量热点的 key 缓存时间失效了。

| 原因                                                        | 解决方案                                                                                                                                                                                                                                                                        |
| ----------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 热点的 key 设置了太短的过期时间。例如秒杀业务下的"库存数量" | 1、设置较长的过期时间。非常重要的 key，则设置永久有效但需要解决好与数据库中的 key 的一致性问题使用分布式锁:如果热点 key 失效了，要控制好访问后端数据库的流量。2、只允许一个请求去访问数据库，取出最新的 key，存放到 redis，其他请求必须等待。但分布式锁也要防止出现异常的情况。 |
